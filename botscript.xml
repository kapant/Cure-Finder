<context>
    <input pattern = "/start">
        <var name = "Cures" scope = "user">
            <script>
                <![CDATA[
                    JSON.parse('[ { "name": "супрастин", "symp": "аллерг" }, { "name": "дротаверин", "symp": "гастрит" }, { "name": "мезим", "symp": "живот" }, { "name": "линекс", "symp": "тошн" }, { "name": "гастал", "symp": "изжога" }, { "name": "риофлора", "symp": "понос" } ]');
                ]]>
            </script>
        </var>
        <output value = "Здравствуйте, что вас беспокоит?"/>
        <context id = "begin">
            <pattern name = "List" value = "[у[меня]] $Text(,| и|.)"/>
            <input pattern = "[у] [меня] [беспокоит] repeat($List)">
                <var name = "Symptomes" scope = "input">
                    <script>
                        <![CDATA[
                            if (typeof($List) == "string") {
                                $List;
                            } else {
                                i = 0;
                                str = "[";
                                while ($List[i]) {
                                    if (i != 0) {
                                        str += ',';
                                    }
                                    str += '"' + $List[i] + '"';
                                    i++;
                                }
                                str += ']';
                                JSON.parse(str);
                            }
                        ]]>
                    </script>
                </var>

                <var name = "Response">
                    <script>
                        <![CDATA[
                            str = "Возможно, вам поможет ";
                            i = 0;
                            while ($Symptomes[i]) {
                                j = 0;
                                while ($Cures[j].name) {
                                    if ($Symptomes[i].indexOf($Cures[j].symp) != -1) {
                                        if (str) {
                                            str += ", " + $Cures[j];
                                        } else {
                                            str += $Cures[j];
                                        }
                                        break;
                                    }
                                    j++;
                                }
                                if (!$Cures[j].name) {
                                    if (str) {
                                        str += ", извините, я не смогу вам помочь, если у вас " + $Symptomes[i];
                                    } else {
                                        str += "извините, я не смогу вам помочь, если у вас " + $Symptomes[i];
                                    }
                                }
                                i++;
                            }
                            str += ".";
                            str;
                        ]]>
                    </script>
                </var>

                <output value = "$Response Если будете чувствовать себя нехорошо - пишите."/>
                
                <context id = "begin"/>    
            </input>

            <input pattern = "* (ничего|хорош*|нормальн*) *">
                <output value = "Если будете чувствовать себя нехорошо - пишите."/>
                <context id = "begin"/>
            </input>

            <input pattern = "*">
                <output value = "Простите, я вас не понимаю. Что вас беспокоит?"/>
                <context id = "begin"/>
            </input>
        </context>
    </input>
</context>