<context>
    <input pattern = "/start">

        <!--Переменная $Cures содержит информацию о симптомах и лекарствах, их лечащих.-->
        <var name = "Cures" scope = "user">
            <script>
                <![CDATA[
                    makeCures(); //Функция makeCures() описана в data.js. В data.js также можно добавить новые позиции для $Cures.
                ]]>
            </script>
        </var>

        <output value = "Здравствуйте, что вас беспокоит?"/>

        <!--Основной контекст-->
        <context id = "begin">

            <!--Шаблон для списка пользовательских симптомов-->
            <pattern name = "List" value = "[у[меня]] $Text(,| и)"/>

            <!--Если пользователь начал перечислять симптомы-->
            <input pattern = "{[у] [меня] [беспокоит] [мо*]} [repeat($List)] $Text">

                <!--Составление списка пользовательских симптомов-->
                <var name = "Symptomes" scope = "input">
                    <script>
                        <![CDATA[

                            //Устанавливается из скольки пунктов состоит список пользовательских симптомов
                            //Если оставить только "else", то в случае с 1м симптомом, он будет разбиваться на буквы

                                //Составление списка в виде JSON-объекта
                                i = 0;
                                str = "[";
                                if (typeof($List) != "undefined") {
                                    if (typeof($List) == "string") {
                                        str += '"' + $List.toLowerCase() + '"';
                                        i++;
                                    } else{
                                        while ($List[i]) {
                                            if (i != 0) {
                                                str += ',';
                                            }
                                            str += '"' + $List[i].toLowerCase() + '"';
                                            i++;
                                        }
                                    }
                                }
                                if (i != 0) {
                                    str += ',';
                                }
                                str += '"' + $Text.toLowerCase() + '"';
                                str += ']';
                                JSON.parse(str);
                        ]]>
                    </script>
                </var>

                <!--Составление ответа. Порядок лекарств соостветствует порядку симптомов-->
                <var name = "Response">
                    <script>
                        <![CDATA[
                            str = ""; //Переменная ответа

                            //Устанавливается из скольки пунктов состоит список пользовательских симптомов
                            if (typeof($Symptomes) == "string") {
                                j = 0;

                                //Поиск нужного лекарства для симптома
                                while ($Cures[j]) {
                                    if ($Symptomes.indexOf($Cures[j].symp) != -1) {
                                        if (str) {
                                            str += ", " + $Cures[j].name;
                                        } else {
                                            str += $Cures[j].name;
                                        }
                                        break;
                                    }
                                    j++;
                                }

                                //Лекарство не найдено
                                if (!$Cures[j]) {
                                    str += ", извините, я не смогу вам помочь, если у вас " + $Symptomes;
                                }
                            } else {
                                i = 0;

                                //Для каждого симптома ищется лекарство
                                while ($Symptomes[i]) {
                                    j = 0;

                                    //Поиск нужного лекарства для симптома
                                    while ($Cures[j]) {
                                        if ($Symptomes[i].indexOf($Cures[j].symp) != -1) {
                                            if (str) {
                                                str += ", " + $Cures[j].name;
                                            } else {
                                                str += $Cures[j].name;
                                            }
                                            break;
                                        }
                                        j++;
                                    }

                                    //Лекарство не найдено
                                    if (!$Cures[j]) {
                                        str += ", извините, я не смогу вам помочь, если у вас " + $Symptomes[i];
                                    }
                                    i++;
                                }
                            }
                            str;
                        ]]>
                    </script>
                </var>

                <!--Ответ пользователю-->
                <output value = "Возможно, вам поможет $Response. Если будете чувствовать себя нехорошо - пишите."/>
                
                <!--Переход в начало-->
                <context id = "begin"/>    
            </input>

            <!--Если у пользователя все хорошо)-->
            <input pattern = "* (ничего|хорош*|нормальн*) *">
                <output value = "Если будете чувствовать себя нехорошо - пишите."/>
                <context id = "begin"/>
            </input>

            <!--Помощь-->
            <input pattern = "/help">
                <output>
                    Этот бот поможет вам выбрать лекарство, отпускающееся без рецепта, от около 20 симптомов разных видов. Не следует сразу применять предложенное лекарство, ОБЯЗАТЕЛЬНО ознакомтесь с препаратом и при необходимости проконсультируйтесь с врачом.

                    При составлении списка симптомов, пожалуйста, ставьте в конце точку, иначе бот не сможет вас понять.

                    Если вас что-то беспокоит - пишите.
                </output>
                <context id = "begin"/>
            </input>

            <!--Непонятный текст-->
            <!--<input pattern = "*">
                <output value = "Простите, я вас не понимаю. Что вас беспокоит?"/>
                <context id = "begin"/>
            </input>-->
        </context>
    </input>
</context>